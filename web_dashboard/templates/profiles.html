{% extends "base.html" %}

{% block title %}–ü—Ä–æ—Ñ–∏–ª–∏ - Analytics{% endblock %}

{% block content %}
<!-- Header -->
<div class="page-header">
    <h2><i class="fas fa-users text-primary me-2"></i>–ü—Ä–æ—Ñ–∏–ª–∏</h2>
    <p class="subtitle mb-0">–í—Å–µ–≥–æ –ø—Ä–æ—Ñ–∏–ª–µ–π: {{ total_profiles }}</p>
</div>

<!-- Filters -->
<div class="card stat-card mb-4">
    <div class="card-body">
        <div class="row g-3 align-items-end">
            <div class="col-lg-3 col-md-6">
                <label class="form-label fw-bold mb-2">
                    <i class="fas fa-layer-group me-1"></i>–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞
                </label>
                <select class="form-select" id="platformFilter">
                    <option value="all">–í—Å–µ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã</option>
                    <option value="tiktok">TikTok</option>
                    <option value="instagram">Instagram</option>
                    <option value="facebook">Facebook</option>
                    <option value="youtube">YouTube</option>
                </select>
            </div>
            <div class="col-lg-3 col-md-6">
                <label class="form-label fw-bold mb-2">
                    <i class="fas fa-tag me-1"></i>–°—Ç–∞—Ç—É—Å
                </label>
                <select class="form-select" id="statusFilter">
                    <option value="all">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
                    <option value="NEW">NEW</option>
                    <option value="OLD">OLD</option>
                    <option value="BAN">BAN</option>
                </select>
            </div>
            <div class="col-lg-3 col-md-6">
                <label class="form-label fw-bold mb-2">
                    <i class="fas fa-sort me-1"></i>–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞
                </label>
                <select class="form-select" id="sortBy">
                    <option value="views">–ü–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞–º</option>
                    <option value="followers">–ü–æ –ø–æ–¥–ø–∏—Å—á–∏–∫–∞–º</option>
                    <option value="content">–ü–æ –∫–æ–Ω—Ç–µ–Ω—Ç—É</option>
                </select>
            </div>
            <div class="col-lg-3 col-md-6">
                <button class="btn btn-primary w-100" onclick="applyFilters()">
                    <i class="fas fa-filter me-2"></i>–ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Profiles Table -->
<div class="card stat-card">
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover align-middle" id="profilesTable">
                <thead class="table-light">
                    <tr>
                        <th style="width: 50px;">#</th>
                        <th style="min-width: 250px;">–ü—Ä–æ—Ñ–∏–ª—å</th>
                        <th style="width: 120px;">–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞</th>
                        <th style="width: 100px;">–°—Ç–∞—Ç—É—Å</th>
                        <th class="text-end" style="width: 120px;">–ü–æ–¥–ø–∏—Å—á–∏–∫–∏</th>
                        <th class="text-end" style="width: 120px;">–ü—Ä–æ—Å–º–æ—Ç—Ä—ã</th>
                        <th class="text-end" style="width: 100px;">–ö–æ–Ω—Ç–µ–Ω—Ç</th>
                    </tr>
                </thead>
                <tbody>
                    {% for profile in profiles %}
                    <tr data-platform="{{ profile.platform }}" data-status="{{ profile.status }}">
                        <td class="fw-bold text-muted">{{ loop.index }}</td>
                        <td>
                            <div class="d-flex align-items-center">
                                <!-- –ê–≤–∞—Ç–∞—Ä–∫–∞ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã -->
                                {% if profile.platform == 'tiktok' %}
                                    <div class="me-3" style="width: 48px; height: 48px; min-width: 48px; border-radius: 50%; background: #000; display: flex; align-items: center; justify-content: center; color: white; font-size: 1.3rem; box-shadow: 0 2px 8px rgba(0,0,0,0.15);">
                                        <i class="fab fa-tiktok"></i>
                                    </div>
                                {% elif profile.platform == 'instagram' %}
                                    <div class="me-3" style="width: 48px; height: 48px; min-width: 48px; border-radius: 50%; background: linear-gradient(45deg, #f09433 0%,#e6683c 25%,#dc2743 50%,#cc2366 75%,#bc1888 100%); display: flex; align-items: center; justify-content: center; color: white; font-size: 1.3rem; box-shadow: 0 2px 8px rgba(225,48,108,0.3);">
                                        <i class="fab fa-instagram"></i>
                                    </div>
                                {% elif profile.platform == 'facebook' %}
                                    <div class="me-3" style="width: 48px; height: 48px; min-width: 48px; border-radius: 50%; background: #1877f2; display: flex; align-items: center; justify-content: center; color: white; font-size: 1.3rem; box-shadow: 0 2px 8px rgba(24,119,242,0.3);">
                                        <i class="fab fa-facebook-f"></i>
                                    </div>
                                {% elif profile.platform == 'youtube' %}
                                    <div class="me-3" style="width: 48px; height: 48px; min-width: 48px; border-radius: 50%; background: #ff0000; display: flex; align-items: center; justify-content: center; color: white; font-size: 1.3rem; box-shadow: 0 2px 8px rgba(255,0,0,0.3);">
                                        <i class="fab fa-youtube"></i>
                                    </div>
                                {% endif %}
                                
                                <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø—Ä–æ—Ñ–∏–ª–µ -->
                                <div style="flex: 1; min-width: 0;">
                                    <a href="{{ profile.url }}" target="_blank" class="text-decoration-none text-dark fw-bold d-block text-truncate" style="font-size: 0.95rem; line-height: 1.4;">
                                        {% if profile.platform in ['tiktok', 'instagram'] %}
                                            @{{ profile.username }}
                                        {% else %}
                                            {{ profile.url }}
                                        {% endif %}
                                    </a>
                                    <div class="text-truncate" style="font-size: 0.8rem; color: #6c757d; margin-top: 2px;">
                                        <i class="fab fa-telegram" style="font-size: 0.75rem; margin-right: 2px;"></i>{{ profile.telegram_user }}
                                    </div>
                                </div>
                            </div>
                        </td>
                        <td>
                            {% if profile.platform == 'tiktok' %}
                                <span class="badge bg-dark"><i class="fab fa-tiktok me-1"></i>TikTok</span>
                            {% elif profile.platform == 'instagram' %}
                                <span class="badge" style="background: linear-gradient(45deg, #f09433 0%,#e6683c 25%,#dc2743 50%,#cc2366 75%,#bc1888 100%);"><i class="fab fa-instagram me-1"></i>Instagram</span>
                            {% elif profile.platform == 'facebook' %}
                                <span class="badge bg-primary"><i class="fab fa-facebook-f me-1"></i>Facebook</span>
                            {% elif profile.platform == 'youtube' %}
                                <span class="badge bg-danger"><i class="fab fa-youtube me-1"></i>YouTube</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if profile.status == 'NEW' %}
                                <span class="badge bg-success">üÜï NEW</span>
                            {% elif profile.status == 'OLD' %}
                                <span class="badge bg-secondary">üì¶ OLD</span>
                            {% elif profile.status == 'BAN' %}
                                <span class="badge bg-danger">üö´ BAN</span>
                            {% endif %}
                        </td>
                        <td class="text-end fw-bold">{{ "{:,}".format(profile.stats.followers or 0).replace(',', ' ') }}</td>
                        <td class="text-end fw-bold text-primary">
                            {% set total_views = profile.stats.total_views or profile.stats.views or 0 %}
                            {{ "{:,}".format(total_views).replace(',', ' ') }}
                        </td>
                        <td class="text-end fw-semibold">
                            {% set total_content = (profile.stats.videos or 0) + (profile.stats.reels or 0) %}
                            {{ total_content }}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤ –∏ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
function applyFilters() {
    const platform = document.getElementById('platformFilter').value;
    const status = document.getElementById('statusFilter').value;
    const sortBy = document.getElementById('sortBy').value;
    
    const table = document.getElementById('profilesTable');
    const rows = Array.from(table.querySelectorAll('tbody tr'));
    
    let visibleRows = [];
    
    // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è —Å—Ç—Ä–æ–∫
    rows.forEach(row => {
        const platformMatch = platform === 'all' || row.dataset.platform === platform;
        const statusMatch = status === 'all' || row.dataset.status === status;
        
        if (platformMatch && statusMatch) {
            row.style.display = '';
            visibleRows.push(row);
        } else {
            row.style.display = 'none';
        }
    });
    
    // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –≤–∏–¥–∏–º—ã—Ö —Å—Ç—Ä–æ–∫
    if (visibleRows.length > 0) {
        let sortIndex;
        if (sortBy === 'views') {
            sortIndex = 5; // –ö–æ–ª–æ–Ω–∫–∞ –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤
        } else if (sortBy === 'followers') {
            sortIndex = 4; // –ö–æ–ª–æ–Ω–∫–∞ –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤
        } else {
            sortIndex = 6; // –ö–æ–ª–æ–Ω–∫–∞ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
        }
        
        visibleRows.sort((a, b) => {
            const aValue = parseInt(a.cells[sortIndex].textContent.replace(/\s/g, '')) || 0;
            const bValue = parseInt(b.cells[sortIndex].textContent.replace(/\s/g, '')) || 0;
            return bValue - aValue; // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ —É–±—ã–≤–∞–Ω–∏—é
        });
        
        // –ü–µ—Ä–µ—É–ø–æ—Ä—è–¥–æ—á–∏–≤–∞–µ–º —Å—Ç—Ä–æ–∫–∏ –≤ —Ç–∞–±–ª–∏—Ü–µ
        const tbody = table.querySelector('tbody');
        visibleRows.forEach((row, index) => {
            row.cells[0].textContent = index + 1; // –û–±–Ω–æ–≤–ª—è–µ–º –Ω–æ–º–µ—Ä —Å—Ç—Ä–æ–∫–∏
            tbody.appendChild(row);
        });
    }
}

// –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', function() {
    applyFilters();
});

// –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –ª—é–±–æ–≥–æ select
['platformFilter', 'statusFilter', 'sortBy'].forEach(id => {
    const element = document.getElementById(id);
    if (element) {
        element.addEventListener('change', applyFilters);
    }
});
</script>
{% endblock %}
